# developブランチへのPRで自動テストの実行とデプロイをしたいやつ
#
name: auto deploy

on:
  pull_request:
    types: [opened, synchronize]
    branches: [ main ]
    paths:
        - 'force-app/**'
  workflow_dispatch:

jobs:
  build:
    name: apex test
    runs-on: ubuntu-latest
    steps: 
      - name: Setup Node.js environment
        uses: actions/setup-node@v4.0.2
        with:
          node-version: '18'    
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: echo "💡 The ${{ github.repository }} repository has been cloned to the runner."
      - name: 'Install Salesforce CLI'
        run: |
          npm install @salesforce/cli --location=global
          nodeInstallPath=$(npm config get prefix)
          echo "$nodeInstallPath/bin" >> $GITHUB_PATH
          sf --version
      #    wget https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz
      #    mkdir ~/sfdx
      #    tar xJf sfdx-linux-x64.tar.xz -C ~/sfdx --strip-components 1
      #    echo "$HOME/sfdx/bin" >> $GITHUB_PATH
      #    ~/sfdx/bin/sfdx version
      
      # sf org display -o [your devhub alias] --verboseの結果を保持したsecretsから取得
      - name: Run a echo script
        shell: bash
        run: |
          echo Hellow, GitHub Action
          echo ${{ secrets.DEVHUB_SFDX_URL }} > ./DEVHUB_SFDX_URL.txt
      # Authenticate to org
      - name: 'Authenticate to Integration Org'
        run: sfdx auth:sfdxurl:store -f ./DEVHUB_SFDX_URL.txt -s -a DevHub_vxa
        #run: sf org login sfdx-url -f ./DEVHUB_SFDX_URL.txt -a DevHub_vxa -d
      # Create a scratch org
      - name: "Create scratch org"
        run: sf org create scratch -d -f config/project-scratch-def -a our-scratch-org --duration-days 1

