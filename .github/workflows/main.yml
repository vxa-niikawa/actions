# develop„Éñ„É©„É≥„ÉÅ„Å∏„ÅÆPR„ÅßËá™Âãï„ÉÜ„Çπ„Éà„ÅÆÂÆüË°å„Å®„Éá„Éó„É≠„Ç§„Çí„Åó„Åü„ÅÑ„ÇÑ„Å§
#
name: auto deploy

on:
  pull_request:
    types: [opened, synchronize]
    branches: [ main ]
    paths:
        - 'force-app/**'
  workflow_dispatch:
 
jobs:
  # set up & cache  
  build:
    name: apex test
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js environment
        uses: actions/setup-node@v4.0.2
        with:
          node-version: '20'
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      # global„Åß„Ç§„É≥„Çπ„Éà„Éº„É´„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã„ÅÇÔΩî„ÇÅ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂà©Áî®„Åß„Åç„Å™„ÅÑ
      # Ê≠£Á¢∫„Å™„Ç§„É≥„Çπ„Éà„Éº„É´ÂÖà„ÅÆ„Éë„Çπ„Åå„Çè„Åã„Çå„Å∞„Ç≠„É£„ÉÉ„Ç∑„É•Âåñ„Åß„Åç„Çã„ÅÆ„Å†„Åå„ÄÇ„ÄÇ„ÄÇ„ÄÇ
      - name: 'install Salesforce CLI'
        run: |
          npm install @salesforce/cli --location=global
          nodeInstallPath=$(npm config get prefix)
          echo "$nodeInstallPath/bin" >> $GITHUB_PATH
          sf --version
      # Â∑ÆÂàÜÊäΩÂá∫Áî®„Å´delta„Çí„Ç§„É≥„Çπ„Éà„Éº„É´
      - name: 'installing sfdx git delta'
        run: | 
          echo y | sfdx plugins:install sfdx-git-delta
          sfdx plugins
      # ‚Äìgenerate-delta„Éï„É©„Ç∞„Çí‰ΩøÁî®„Åó„Å¶„ÄÅËøΩÂä†„Åæ„Åü„ÅØÂ§âÊõ¥„Åï„Çå„Åü„É°„Çø„Éá„Éº„Çø„ÅÆ„Åø„ÇíÂê´„ÇÄforce-app„Éï„Ç©„É´„ÉÄ„Éº„ÅÆ„Ç≥„Éî„Éº„ÇíÁîüÊàê
      - name: 'Create delta packages for new, modified or deleted metadata'
        # ÂØæË±°PR„Å®„ÅÆÂ∑ÆÂàÜ„ÇíÊäΩÂá∫
        run: |
           mkdir changed-sources
           sfdx sgd:source:delta --to "HEAD" --from "HEAD^" --output changed-sources/ --generate-delta --source force-app/

      # sf org display -o [your devhub alias] --verbose„ÅÆÁµêÊûú„Çí‰øùÊåÅ„Åó„Åüsecrets„Åã„ÇâÂèñÂæó
      - name: Run a echo script
        shell: bash
        run: |
          echo Hellow, GitHub Action
          echo ${{ secrets.DEVHUB_SFDX_URL }} > ./DEVHUB_SFDX_URL.txt
      
      # Authenticate to org
      - name: 'Authenticate to Integration Org'
        run: sfdx auth:sfdxurl:store -f ./DEVHUB_SFDX_URL.txt -s -a DevHub_vxa
        #run: sf org login sfdx-url -f ./DEVHUB_SFDX_URL.txt -a DevHub_vxa -d

      # Â∑ÆÂàÜ„Éá„Éó„É≠„Ç§„ÇíÂÆüË°å
      # „ÉÜ„Çπ„ÉàÂÖ®ÂÆüË°å„Åó„Å¶„ÅÑ„Çã„ÅÆ„ÅßÊåáÂÆö„Åï„Çå„Å¶„ÇÇ„ÅÆ„Å†„Åë„Å´„Åó„Åü„ÅÑ
      - name: 'deploy delta'
        run: |
          result=sfdx force:source:deploy -p changed-sources/force-app --checkonly --testlevel RunLocalTests --json
          echo "DRY_DEPLOY_RESULT=$result" >> $GITHUB_ENV

      - name: Parse JSON Response
        id: parse_json
        run: |
          echo "${{ env.DRY_DEPLOY_RESULT }}" | jq '.id' > parsed_value.txt
          parsed_value=$(cat parsed_value.txt)
          echo "PARSED_VALUE=$parsed_value" >> $GITHUB_ENV

      - name: Use Parsed Value
        run: echo ${{ env.PARSED_VALUE }}
      
      # Áõ¥Ââç„ÅÆ„Éá„Éó„É≠„Ç§Êìç‰Ωú„Çí„Ç≠„É£„É≥„Çª„É´
      - name: 'cancel deploy'
        run: sf project deploy cancel --job-id ${{ env.PARSED_VALUE }}
        #run: sf project deploy cancel --use-most-recent
      
      # Create a scratch org
      #- name: "Create scratch org"
      #  run: sf org create scratch -d -f config/project-scratch-def.json -a our-scratch-org --target-dev-hub DevHub_vxa --duration-days 1

