# developãƒ–ãƒ©ãƒ³ãƒã¸ã®PRã§è‡ªå‹•ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã—ãŸã„ã‚„ã¤
#
name: auto deploy

on:
  pull_request:
    types: [opened, synchronize]
    branches: [ main ]
    paths:
        - 'force-app/**'
  workflow_dispatch:
 
jobs:
  # set up & cache  
  build:
    name: apex test
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js environment
        uses: actions/setup-node@v4.0.2
        with:
          node-version: '20'
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: echo "ðŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      # globalã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚ï½”ã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã§ããªã„
      # æ­£ç¢ºãªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã®ãƒ‘ã‚¹ãŒã‚ã‹ã‚Œã°ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŒ–ã§ãã‚‹ã®ã ãŒã€‚ã€‚ã€‚ã€‚
      - name: 'install Salesforce CLI'
        run: |
          npm install @salesforce/cli --location=global
          nodeInstallPath=$(npm config get prefix)
          echo "$nodeInstallPath/bin" >> $GITHUB_PATH
          sf --version
      # å·®åˆ†æŠ½å‡ºç”¨ã«deltaã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: 'installing sfdx git delta'
        run: | 
          echo y | sfdx plugins:install sfdx-git-delta
          sfdx plugins
      # â€“generate-deltaãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ã—ã¦ã€è¿½åŠ ã¾ãŸã¯å¤‰æ›´ã•ã‚ŒãŸãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å«ã‚€force-appãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã®ã‚³ãƒ”ãƒ¼ã‚’ç”Ÿæˆ
      - name: 'Create delta packages for new, modified or deleted metadata'
        # å¯¾è±¡PRã¨ã®å·®åˆ†ã‚’æŠ½å‡º
        run: |
           mkdir changed-sources
           sfdx sgd:source:delta --to "HEAD" --from "HEAD^" --output changed-sources/ --generate-delta --source force-app/

      # sf org display -o [your devhub alias] --verboseã®çµæžœã‚’ä¿æŒã—ãŸsecretsã‹ã‚‰å–å¾—
      - name: Run a echo script
        shell: bash
        run: |
          echo Hellow, GitHub Action
          echo ${{ secrets.DEVHUB_SFDX_URL }} > ./DEVHUB_SFDX_URL.txt
      
      # Authenticate to org
      - name: 'Authenticate to Integration Org'
        run: sfdx auth:sfdxurl:store -f ./DEVHUB_SFDX_URL.txt -s -a DevHub_vxa
        #run: sf org login sfdx-url -f ./DEVHUB_SFDX_URL.txt -a DevHub_vxa -d

      - name: 'deploy delta'
        run: sfdx force:source:deploy -p changed-sources/force-app --checkonly --testlevel RunLocalTests --json
      
      # Create a scratch org
      #- name: "Create scratch org"
      #  run: sf org create scratch -d -f config/project-scratch-def.json -a our-scratch-org --target-dev-hub DevHub_vxa --duration-days 1

