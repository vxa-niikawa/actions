# DryDaployInfoã«ä¿æŒã•ã‚Œã¦ã„ã‚‹ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒªãƒ¼ã‚¹å¯¾è±¡ã‚’å–å¾—ã—ãƒªãƒªãƒ¼ã‚¹ã‚’è¡Œã†
name: ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒªãƒ¼ã‚¹

on:
  workflow_dispatch:

jobs:
  # set up & cache  
  release:
    name: quick release
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js environment
        uses: actions/setup-node@v4.0.2
        with:
          node-version: '20'
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: echo "ðŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      # globalã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã§ããªã„
      # æ­£ç¢ºãªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã®ãƒ‘ã‚¹ãŒã‚ã‹ã‚Œã°ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŒ–ã§ãã‚‹ã®ã ãŒã€‚ã€‚ã€‚ã€‚
      - name: 'install Salesforce CLI'
        run: |
          npm install @salesforce/cli --location=global
          nodeInstallPath=$(npm config get prefix)
          echo "$nodeInstallPath/bin" >> $GITHUB_PATH
          sf --version

      - name: Get Login URL
        run: echo ${{ secrets.DEVHUB_SFDX_URL }} > ./DEVHUB_SFDX_URL.txt

      - name: Authenticate to Org
        run: sfdx auth:sfdxurl:store -f ./DEVHUB_SFDX_URL.txt -s -a DevHub_vxa

      - name: Get Taerget Records
        run: |
          sf data query --query "SELECT Id, Name, JOB_Id__c, PR_Number__c FROM DryDaployInfo__c WHERE Status__c = 'ready' Order By CreatedDate Desc" --json > result.json
          cat result.json

      - name: released
        run: |
          data=$(cat result.json)
          records=$(echo $data | jq -c '.result.records[]')
          for record in $records; do
            record_id=$(echo $record | jq -r '.Id')
            job_id=$(echo $record | jq -r '.Job_Id__c')
            sf project deploy quick --job-id $job_id
            current_datetime=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            sf data update record --sobject DryDaployInfo__c --record-id $record_id --values "Status__c='released' Released_Date__c='$current_datetime'"
          done
      
